# Arduino-MCP 開発ロードマップ

ESP32開発をAI駆動で効率化するMCPベース開発ツールパッケージの開発計画

---

## ビジョン

Arduino IDEとは異なる味付けの、**MCP (Model Context Protocol) ベースのAI駆動ESP32開発ツール**を構築する。
複数台のESP32デバイスを開発・導入・メンテナンスまで一貫してAIと協調して行える環境を目指す。

---

## アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────────────┐
│  Claude Code / LLM                                                  │
└───────────────────────────────┬─────────────────────────────────────┘
                                │ MCP Protocol
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐     ┌─────────────────┐     ┌─────────────────────┐
│ Arduino-MCP   │     │ ESP32 Serial    │     │ Chrome DevTools     │
│ Server        │     │ Console         │     │ MCP                 │
│               │     │                 │     │                     │
│ - compile     │     │ - シリアル監視   │     │ - Console API連携   │
│ - upload      │     │ - ファイル管理   │     │ - ログ取得          │
│ - board管理   │     │ - ピンマッパー   │     │                     │
│ - SPIFFS操作  │◄───►│ - MQTTブローカー │◄───►│                     │
└───────────────┘     └─────────────────┘     └─────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐     ┌─────────────────┐     ┌─────────────────────┐
│ ESP32 #1      │     │ ESP32 #2        │     │ ESP32 #N            │
│ (ローカル)     │     │ (ローカル)       │     │ (VPN経由)           │
└───────────────┘     └─────────────────┘     └─────────────────────┘
```

---

## フェーズ別開発計画

### Phase 1: 基盤整備 (現在)

#### 1.1 ESP32側 SPIFFS API
- [ ] `/api/spiffs/list` - ファイル一覧取得
- [ ] `/api/spiffs/read` - ファイル読み込み
- [ ] `/api/spiffs/write` - ファイル書き込み
- [ ] `/api/spiffs/delete` - ファイル削除
- [ ] `/api/spiffs/info` - ストレージ情報
- [ ] `/api/spiffs/format` - フォーマット (確認付き)

#### 1.2 ESP32 Serial Console 基盤
- [ ] シリアルセッション管理
- [ ] リングバッファによるログ保持
- [ ] REST API公開
- [ ] WebSocketストリーミング

#### 1.3 Arduino-MCP 改善
- [ ] Console API連携ツール追加
- [ ] エラーハンドリング統一
- [ ] レスポンスフォーマット標準化

---

### Phase 2: ファイルエクスプローラ & ピンマッパー

#### 2.1 ファイルエクスプローラUI (Console内)
- [ ] SPIFFS/LittleFS ファイル一覧表示
- [ ] ファイルアップロード/ダウンロード
- [ ] ファイル編集 (JSON, テキスト)
- [ ] ストレージ使用量可視化

#### 2.2 ピンマッパー機能
目的: 開発者→AI間のPIN情報の言葉足らず問題を解決

```
┌─────────────────────────────────────────────────────────┐
│ ピンマッパーUI                                           │
├─────────────────────────────────────────────────────────┤
│ ボード選択: [ESP32-WROOM-32 38PIN ▼]                    │
├─────┬──────────┬────────────┬───────────────────────────┤
│ PIN │ 機能      │ 用途       │ 備考                      │
├─────┼──────────┼────────────┼───────────────────────────┤
│ GPIO4│ ADC2_CH0 │ 温度センサー │ HT30接続、配線都合でGPIO20から変更│
│ GPIO21│ I2C SDA │ OLED SDA   │ SSD1306 128x64           │
│ GPIO22│ I2C SCL │ OLED SCL   │                          │
│ ...  │          │            │                          │
└─────┴──────────┴────────────┴───────────────────────────┘
                        ↓ エクスポート
┌─────────────────────────────────────────────────────────┐
│ pin_mapping.md (LLMコンテキスト用)                       │
│                                                         │
│ # プロジェクト: mercury_net_diag                         │
│ # ボード: ESP32-WROOM-32 38PIN                          │
│                                                         │
│ | PIN | 機能 | 用途 | 備考 |                             │
│ |-----|------|------|------|                             │
│ | GPIO4 | ADC2_CH0 | 温度センサー | HT30, GPIO20から変更 |│
│ ...                                                     │
└─────────────────────────────────────────────────────────┘
```

- [ ] ボードテンプレート (38PIN, 30PIN, ESP32-S3等)
- [ ] PIN機能リファレンス (GPIO, I2C, SPI, ADC, DAC, etc.)
- [ ] プロジェクト別PIN割り当てUI
- [ ] .md形式エクスポート (LLMコンテキスト用)
- [ ] 配線図生成 (オプション)

#### 2.3 コンポーネントリファレンス
- [ ] I2Cデバイスライブラリ (SSD1306, HT30, BME280, etc.)
- [ ] 解像度、アドレス、基本仕様の参照DB
- [ ] プロジェクトへの紐付け

---

### Phase 3: テスト & 通信機能

#### 3.1 Firebase Pub/Sub連携
- [ ] 既存Firebase連携プロジェクトとの統合
- [ ] エンドポイント設定UI
- [ ] 送受信テスト機能
- [ ] 自動テストスイート

#### 3.2 内蔵MQTTブローカー (テスト用)
- [ ] ローカルMQTTブローカー起動
- [ ] トピック監視UI
- [ ] Pub/Subテスト機能
- [ ] ESP32との接続テスト

#### 3.3 Bluetoothテスト機能
- [ ] 外付けESP32でBTアドバタイズ送信
- [ ] ターゲットESP32でBT受信テスト
- [ ] アドバタイズデータ解析

---

### Phase 4: 高度な機能 & デプロイメント

#### 4.1 条件トリガーエンジン
- [ ] パターンマッチングエンジン
- [ ] 「*が検出されるまでログ取得」
- [ ] ボーレート自動検出
- [ ] アラート通知

#### 4.2 一括OTAアップデート
- [ ] 複数デバイス選択UI
- [ ] ファームウェアバージョン管理
- [ ] ローリングアップデート
- [ ] ロールバック機能

#### 4.3 VPN越しデバイス接続
- [ ] VPN経由ESP32のIP取得
- [ ] mDNS/ブロードキャスト偽装
- [ ] ローカル開発環境へのポート公開
- [ ] リモートシリアルコンソール

#### 4.4 複数台一括操作
- [ ] デバイスグループ管理
- [ ] 一括コマンド実行
- [ ] 状態ダッシュボード

---

## プロジェクト構成方針

### 開発プロジェクト (本リポジトリ)
Arduino-MCPツールパッケージ自体の開発用

```
arduino_mcp/
├── src/              # MCP Server ソース
├── dist/             # ビルド済み
├── docs/             # ドキュメント
├── tests/            # テスト
├── sketches/         # サンプルスケッチ
└── mercury_net_diag/ # 開発用テストスケッチ
```

### ユーザープロジェクト (利用時)
Arduino-MCPを別プロジェクトで使用する場合

```
user_project/
├── src/                    # ユーザーのコード
├── ArduinoMCP_dev/         # Arduino-MCP専用ディレクトリ
│   ├── .config/            # MCP設定
│   ├── builds/             # ビルド済みスケッチ
│   ├── logs/               # シリアルログ
│   ├── pin_mapping.md      # ピンマッピング
│   ├── components.md       # コンポーネント参照
│   └── .cache/             # キャッシュ
├── sketches/               # Arduinoスケッチ
└── ...
```

**目的**: ユーザープロジェクトのルートを汚さない。
Arduino-MCP関連ファイルは `ArduinoMCP_dev/` に集約。

---

## ESP32 Serial Console 機能一覧

| カテゴリ | 機能 | Phase |
|---------|------|-------|
| **シリアル** | 複数ポート同時監視 | 1 |
| | リアルタイムストリーミング | 1 |
| | ログバッファリング | 1 |
| | 条件トリガー | 4 |
| | ボーレート自動検出 | 4 |
| **ファイル** | SPIFFS/LittleFS参照 | 2 |
| | アップロード/ダウンロード | 2 |
| | ストレージ情報 | 1 |
| **リファレンス** | ピンマッパー | 2 |
| | コンポーネントDB | 2 |
| **通信テスト** | MQTTブローカー | 3 |
| | Bluetoothテスト | 3 |
| | Firebase連携 | 3 |
| **デプロイ** | OTAアップデート | 4 |
| | VPN接続 | 4 |

---

## API設計 (詳細)

### シリアル関連
```
GET    /api/serial/ports
POST   /api/serial/connect
DELETE /api/serial/{sessionId}
GET    /api/serial/{sessionId}/buffer
POST   /api/serial/{sessionId}/capture
PATCH  /api/serial/{sessionId}/baudrate
WS     /api/serial/{sessionId}/stream
```

### ファイル関連
```
GET    /api/device/{deviceId}/files
GET    /api/device/{deviceId}/files/{path}
PUT    /api/device/{deviceId}/files/{path}
DELETE /api/device/{deviceId}/files/{path}
GET    /api/device/{deviceId}/storage
POST   /api/device/{deviceId}/storage/format
```

### リファレンス関連
```
GET    /api/boards                    # ボードテンプレート一覧
GET    /api/boards/{boardId}/pins     # PIN定義取得
GET    /api/components                # コンポーネント一覧
GET    /api/components/{id}           # コンポーネント詳細
POST   /api/projects/{id}/pin-mapping # ピンマッピング保存
GET    /api/projects/{id}/pin-mapping # ピンマッピング取得
```

---

## 既知の課題 & 改善点

### 発見済みの問題 (2024-12-09)

1. **settingManager.cpp のデバッグコード残存**
   - `SPIFFS.format()` が毎起動実行される問題
   - → 解決済み

2. **シリアルポート競合**
   - 複数プロセスがポートを占有
   - → Console側でセッション管理必要

3. **Web UI フィードバック不足**
   - 保存/再起動の成功/失敗がわかりにくい
   - → 解決済み (フィードバックUI追加)

### 今後の改善点

- [ ] スケッチテンプレートの品質管理プロセス
- [ ] MCP応答フォーマットの標準化
- [ ] エラーハンドリングの統一
- [ ] E2Eテストの整備

---

## 関連プロジェクト

- **ESP32 Serial Console**: シリアル監視 & ファイル管理UI
- **Chrome DevTools MCP**: ブラウザ連携
- **Firebase連携プロジェクト**: Pub/Sub & 自動テスト

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2024-12-09 | 初版作成、Phase 1-4 計画策定 |

